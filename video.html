<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OMGTube - –í–∏–¥–µ–æ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial; background: #0f0f0f; color: white; }
        
        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .navbar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 24px; background: #212121; position: sticky; top: 0; z-index: 1000;
        }
        .logo { font-size: 24px; font-weight: bold; color: #ff0000; text-decoration: none; }
        .nav-links a { color: white; text-decoration: none; margin-left: 20px; }
        
        /* –í–∏–¥–µ–æ –ø–ª–µ–µ—Ä */
        .video-container {
            max-width: 1200px; margin: 20px auto; padding: 0 20px;
        }
        .video-player {
            width: 100%; aspect-ratio: 16/9; background: #000;
            border-radius: 12px; overflow: hidden; margin-bottom: 20px;
        }
        .video-player video { width: 100%; height: 100%; }
        .video-title { font-size: 24px; font-weight: bold; margin: 15px 0; }
        .video-actions {
            display: flex; gap: 20px; margin: 20px 0; border-bottom: 1px solid #383838;
            padding-bottom: 20px;
        }
        .action-btn {
            background: none; border: none; color: white; cursor: pointer;
            display: flex; align-items: center; gap: 8px; padding: 8px 16px;
            border-radius: 20px; transition: background 0.3s;
        }
        .action-btn:hover { background: #383838; }
        .action-btn.active { color: #ff0000; }
        
        /* –û–ø–∏—Å–∞–Ω–∏–µ */
        .video-description {
            background: #212121; padding: 20px; border-radius: 12px;
            margin: 20px 0; line-height: 1.6;
        }
        
        /* –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ */
        .comments-section { margin-top: 30px; }
        .comment-input {
            display: flex; gap: 10px; margin-bottom: 30px;
        }
        .comment-input input {
            flex: 1; padding: 12px; background: #121212;
            border: 1px solid #383838; border-radius: 20px; color: white;
        }
        .comment-btn {
            background: #ff0000; color: white; border: none;
            padding: 12px 24px; border-radius: 20px; cursor: pointer;
        }
        .comment {
            display: flex; gap: 15px; padding: 15px 0; border-bottom: 1px solid #383838;
        }
        .comment-avatar {
            width: 40px; height: 40px; border-radius: 50%;
            background: linear-gradient(45deg, #ff0000, #ff6b6b);
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; flex-shrink: 0;
        }
        .comment-content { flex: 1; }
        .comment-header {
            display: flex; justify-content: space-between; margin-bottom: 8px;
        }
        .comment-username { font-weight: bold; }
        .comment-text { margin-bottom: 10px; line-height: 1.5; }
        .comment-actions {
            display: flex; gap: 15px; color: #aaa; font-size: 14px;
        }
        .comment-action {
            cursor: pointer; display: flex; align-items: center; gap: 5px;
            transition: color 0.3s;
        }
        .comment-action:hover { color: white; }
        .comment-action.active { color: #ff0000; }
        
        /* –û—Ç–≤–µ—Ç—ã –Ω–∞ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ */
        .reply-form {
            margin: 10px 0 0 55px; display: none;
        }
        .replies {
            margin-left: 55px; border-left: 2px solid #383838; padding-left: 15px;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed; bottom: 20px; right: 20px; background: #4CAF50; color: white;
            padding: 15px 25px; border-radius: 8px; z-index: 3000; display: none;
        }
        
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .video-container { padding: 0 10px; }
            .comment { flex-direction: column; }
            .replies { margin-left: 20px; }
        }
    </style>
</head>
<body>
    <!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
    <nav class="navbar">
        <a href="index.html" class="logo">OMGTube</a>
        <div class="nav-links">
            <a href="index.html">‚Üê –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
        </div>
    </nav>

    <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
    <div class="video-container">
        <div class="video-player" id="video-player">
            <!-- –í–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
        </div>
        
        <h1 class="video-title" id="video-title"></h1>
        
        <div class="video-actions">
            <button class="action-btn" id="like-btn" onclick="likeVideo()">
                <span id="like-icon">‚ù§Ô∏è</span>
                <span id="like-count">0</span>
            </button>
            <button class="action-btn" id="subscribe-btn" onclick="subscribe()">
                <span id="subscribe-icon">üîî</span>
                <span id="subscribe-text">–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è</span>
            </button>
        </div>
        
        <div class="video-description" id="video-description"></div>
        
        <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ -->
        <div class="comments-section">
            <h3>üí¨ –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ (<span id="comments-count">0</span>)</h3>
            
            <div class="comment-input">
                <input type="text" id="new-comment" placeholder="–î–æ–±–∞–≤–∏—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π...">
                <button class="comment-btn" onclick="addComment()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
            
            <div id="comments-list">
                <!-- –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ -->
    <div id="notification" class="notification"></div>

    <!-- Supabase –∏ —Å–∫—Ä–∏–ø—Ç -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // =================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ===================
        const SUPABASE_URL = 'https://sbrbed72ad5k3gr9di_uug.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_sBrBED72Ad5k3GR9DI_uUg_-AwTf8LA';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        let currentVideo = null;
        let isSubscribed = false;
        
        // =================== –ó–ê–ì–†–£–ó–ö–ê –í–ò–î–ï–û ===================
        async function loadVideo() {
            const urlParams = new URLSearchParams(window.location.search);
            const videoId = urlParams.get('id');
            
            if (!videoId) {
                window.location.href = 'index.html';
                return;
            }
            
            // 1. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤–∏–¥–µ–æ
            const { data: video, error } = await supabase
                .from('videos')
                .select(`
                    *,
                    profiles:user_id (username, avatar_url, id)
                `)
                .eq('id', videoId)
                .single();
            
            if (error || !video) {
                showNotification('–í–∏–¥–µ–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ');
                setTimeout(() => window.location.href = 'index.html', 2000);
                return;
            }
            
            currentVideo = video;
            
            // 2. –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('video-title').textContent = video.title;
            document.getElementById('video-description').textContent = video.description;
            document.getElementById('like-count').textContent = video.likes_count || 0;
            
            // 3. –í—Å—Ç–∞–≤–ª—è–µ–º –≤–∏–¥–µ–æ
            const videoPlayer = document.getElementById('video-player');
            videoPlayer.innerHTML = `
                <video controls autoplay style="width:100%;height:100%;">
                    <source src="${video.video_url}" type="video/mp4">
                    –í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤–∏–¥–µ–æ.
                </video>
            `;
            
            // 4. –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
            await checkAuth();
            if (currentUser) {
                await checkSubscription(video.user_id);
                await checkLike();
            }
            
            // 5. –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏
            await loadComments();
            
            // 6. –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä—ã
            incrementViews(videoId);
        }
        
        // =================== –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ò ===================
        async function loadComments() {
            if (!currentVideo) return;
            
            const { data: comments, error } = await supabase
                .from('comments')
                .select(`
                    *,
                    profiles:user_id (username, avatar_url),
                    comment_likes(count)
                `)
                .eq('video_id', currentVideo.id)
                .is('parent_comment_id', null)
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤:', error);
                return;
            }
            
            const commentsList = document.getElementById('comments-list');
            commentsList.innerHTML = '';
            
            comments.forEach(comment => {
                renderComment(comment, commentsList);
            });
            
            document.getElementById('comments-count').textContent = comments.length;
        }
        
        function renderComment(comment, container, isReply = false) {
            const commentDiv = document.createElement('div');
            commentDiv.className = 'comment' + (isReply ? ' reply' : '');
            commentDiv.id = `comment-${comment.id}`;
            
            const likesCount = comment.comment_likes?.[0]?.count || 0;
            const isLiked = comment.user_liked || false;
            
            commentDiv.innerHTML = `
                <div class="comment-avatar">${comment.profiles?.username?.charAt(0) || 'U'}</div>
                <div class="comment-content">
                    <div class="comment-header">
                        <span class="comment-username">${comment.profiles?.username || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å'}</span>
                        <span style="color:#aaa;font-size:14px;">${new Date(comment.created_at).toLocaleDateString()}</span>
                    </div>
                    <div class="comment-text">${comment.content}</div>
                    <div class="comment-actions">
                        <span class="comment-action ${isLiked ? 'active' : ''}" onclick="likeComment('${comment.id}')">
                            ‚ù§Ô∏è ${likesCount}
                        </span>
                        <span class="comment-action" onclick="showReplyForm('${comment.id}')">
                            üí¨ –û—Ç–≤–µ—Ç–∏—Ç—å
                        </span>
                        ${currentUser?.id === comment.user_id ? 
                            `<span class="comment-action" onclick="deleteComment('${comment.id}')">üóë –£–¥–∞–ª–∏—Ç—å</span>` : ''}
                    </div>
                    <div class="reply-form" id="reply-form-${comment.id}">
                        <input type="text" id="reply-input-${comment.id}" placeholder="–í–∞—à –æ—Ç–≤–µ—Ç...">
                        <button onclick="addReply('${comment.id}')">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
                    </div>
                    <div class="replies" id="replies-${comment.id}"></div>
                </div>
            `;
            
            container.appendChild(commentDiv);
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Ç–≤–µ—Ç—ã
            loadReplies(comment.id);
        }
        
        async function loadReplies(commentId) {
            const { data: replies } = await supabase
                .from('comments')
                .select(`
                    *,
                    profiles:user_id (username, avatar_url)
                `)
                .eq('parent_comment_id', commentId)
                .order('created_at', { ascending: true });
            
            if (replies?.length) {
                const repliesContainer = document.getElementById(`replies-${commentId}`);
                replies.forEach(reply => {
                    renderComment(reply, repliesContainer, true);
                });
            }
        }
        
        // =================== –î–ï–ô–°–¢–í–ò–Ø ===================
        async function addComment() {
            if (!currentUser) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
                return;
            }
            
            const input = document.getElementById('new-comment');
            const content = input.value.trim();
            
            if (!content) return;
            
            const { error } = await supabase
                .from('comments')
                .insert([{
                    video_id: currentVideo.id,
                    user_id: currentUser.id,
                    content: content
                }]);
            
            if (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è');
            } else {
                input.value = '';
                loadComments();
                showNotification('–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –¥–æ–±–∞–≤–ª–µ–Ω');
            }
        }
        
        async function addReply(commentId) {
            if (!currentUser) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
                return;
            }
            
            const input = document.getElementById(`reply-input-${commentId}`);
            const content = input.value.trim();
            
            if (!content) return;
            
            const { error } = await supabase
                .from('comments')
                .insert([{
                    video_id: currentVideo.id,
                    user_id: currentUser.id,
                    content: content,
                    parent_comment_id: commentId
                }]);
            
            if (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –æ—Ç–≤–µ—Ç–∞');
            } else {
                input.value = '';
                loadReplies(commentId);
                showNotification('–û—Ç–≤–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω');
            }
        }
        
        async function likeVideo() {
            if (!currentUser) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
                return;
            }
            
            const { data: existing } = await supabase
                .from('video_likes')
                .select()
                .eq('video_id', currentVideo.id)
                .eq('user_id', currentUser.id)
                .single();
            
            if (existing) {
                // –£–¥–∞–ª—è–µ–º –ª–∞–π–∫
                await supabase
                    .from('video_likes')
                    .delete()
                    .eq('id', existing.id);
                
                await supabase
                    .from('videos')
                    .update({ likes_count: (currentVideo.likes_count || 0) - 1 })
                    .eq('id', currentVideo.id);
                
                document.getElementById('like-btn').classList.remove('active');
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –ª–∞–π–∫
                await supabase
                    .from('video_likes')
                    .insert([{
                        video_id: currentVideo.id,
                        user_id: currentUser.id,
                        is_like: true
                    }]);
                
                await supabase
                    .from('videos')
                    .update({ likes_count: (currentVideo.likes_count || 0) + 1 })
                    .eq('id', currentVideo.id);
                
                document.getElementById('like-btn').classList.add('active');
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
            currentVideo.likes_count = (currentVideo.likes_count || 0) + (existing ? -1 : 1);
            document.getElementById('like-count').textContent = currentVideo.likes_count;
        }
        
        async function subscribe() {
            if (!currentUser) {
                showNotification('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ –∞–∫–∫–∞—É–Ω—Ç');
                return;
            }
            
            if (currentUser.id === currentVideo.user_id) {
                showNotification('–ù–µ–ª—å–∑—è –ø–æ–¥–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ —Å–µ–±—è');
                return;
            }
            
            if (isSubscribed) {
                // –û—Ç–ø–∏—Å—ã–≤–∞–µ–º—Å—è
                await supabase
                    .from('subscriptions')
                    .delete()
                    .eq('subscriber_id', currentUser.id)
                    .eq('channel_id', currentVideo.user_id);
                
                isSubscribed = false;
                document.getElementById('subscribe-btn').classList.remove('active');
                document.getElementById('subscribe-text').textContent = '–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è';
                showNotification('–û—Ç–ø–∏—Å–∞–ª–∏—Å—å');
            } else {
                // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è
                await supabase
                    .from('subscriptions')
                    .insert([{
                        subscriber_id: currentUser.id,
                        channel_id: currentVideo.user_id
                    }]);
                
                isSubscribed = true;
                document.getElementById('subscribe-btn').classList.add('active');
                document.getElementById('subscribe-text').textContent = '–í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã';
                showNotification('–ü–æ–¥–ø–∏—Å–∞–ª–∏—Å—å!');
            }
        }
        
        // =================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ===================
        async function checkAuth() {
            const { data: { session } } = await supabase.auth.getSession();
            currentUser = session?.user || null;
        }
        
        async function checkSubscription(channelId) {
            if (!currentUser) return;
            
            const { data } = await supabase
                .from('subscriptions')
                .select()
                .eq('subscriber_id', currentUser.id)
                .eq('channel_id', channelId)
                .single();
            
            isSubscribed = !!data;
            
            const btn = document.getElementById('subscribe-btn');
            if (isSubscribed) {
                btn.classList.add('active');
                document.getElementById('subscribe-text').textContent = '–í—ã –ø–æ–¥–ø–∏—Å–∞–Ω—ã';
            }
        }
        
        async function checkLike() {
            if (!currentUser || !currentVideo) return;
            
            const { data } = await supabase
                .from('video_likes')
                .select()
                .eq('video_id', currentVideo.id)
                .eq('user_id', currentUser.id)
                .single();
            
            if (data) {
                document.getElementById('like-btn').classList.add('active');
            }
        }
        
        async function incrementViews(videoId) {
            await supabase.rpc('increment_views', { video_id: videoId });
        }
        
        function showReplyForm(commentId) {
            const form = document.getElementById(`reply-form-${commentId}`);
            form.style.display = form.style.display === 'flex' ? 'none' : 'flex';
        }
        
        function showNotification(message) {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.style.display = 'block';
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        // =================== –ó–ê–ü–£–°–ö ===================
        document.addEventListener('DOMContentLoaded', loadVideo);
        
        // Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        document.getElementById('new-comment')?.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addComment();
        });
    </script>
</body>
</html>
